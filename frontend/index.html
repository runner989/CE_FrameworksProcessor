<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>CE Frameworks Processor</title>
    <link rel="stylesheet" href="src/style.css" />
</head>
<body>
    <script type="module" src="./src/main.js"></script>      
    <div id="app">
        <div id="logo-title-container">
            <img alt="CE logo" id="logo" src="./src/assets/images/CFLogo.png">
            <h1>Compliance Essentials Frameworks Processor</h1>
        </div>
        <div class="controls"> 
            <div class="section-container" id="evidence">
                Evidence List/Mapping<br>
                <div class="evButtons" id="buttons">
                    <button class="btn">Update Evidence List from Airtable</button>
                    <button class="btn">Process Evidence Mappings</button>
                </div>
            </div>
            <div class="section-container" id="frameworks">
                Frameworks
                <div class="fwButtons" id="buttons">
                    <button class="btn">Add New Framework</button>
                    <button class="btn">Update Framework(s)</button>
                    <p></p>
                    <button class="btn">Update Framework IDs</button>
                    <button class="btn">Export Framework(s)</button>
                    <br><span></span>
                    <button class="btn">Remove/Delete Framework</button>
                </div>
            </div>
            <div class="section-container" id="build">
                Framework Build List
                <div class="fbButtons" id="buttons">
                    <button class="btn" id="getFrameworkBuildListButton">Get Frameworks Build List</button>
                </div>

                <div id="recordsModal" class="modal">
                    <div class="modal-content">
                        <span id="closeModal">&times;</span>
                        <div id="recordsContainer"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
            // Define the specific fields to display in the desired order
            var orderedFields = [
                'Name',
                'UAT_Stage',
                'Stage Framework Number',
                'Production Framework Number',
                'Notes',
                'Category',
                'Status',
            ];
            document.getElementById('getFrameworkBuildListButton').addEventListener('click',function() {
                window.go.main.App.GetFrameworkLookup()
                    .then(function(records) {
                        // console.log('Records:', records)
                        displayRecords(records);
                    })
                    .catch(function(err) {
                        console.error('Error fetching records:', err);
                        alert('Failed to retrieve records.');
                    });
            });
            // Function to display records in the modal
            function displayRecords(records) {
                var modal = document.getElementById('recordsModal');
                var recordsContainer = document.getElementById('recordsContainer');


                var content = '<h2>Frameworks Build List</h2>';
                content += '<div id="selectedRecordLabel">...</div>';
                content += '<div id="tableContainer"><table><thead><tr>';

                orderedFields.forEach(function(field){
                    content += '<th>' + field + '</th>';
                });
                content += '</tr></thead><tbody>';

                records.forEach(function(record, index) {
                    var fields = record.fields;
                    content += '<tr data-index="' + index + '">';
                    orderedFields.forEach(function(field) {
                        var value = fields[field];
                        // Handle different data types
                        if (Array.isArray(value)) {
                            value = value.join(', ');
                        } else if (typeof value == 'object' && value !== null) {
                            value = JSON.stringify(value);
                        } else if (value == undefined || value === null) {
                            value = '';
                        }
                        content += '<td>' + value + '</td>';
                    });
                    content += '</tr>';    
                });
                content += '</tbody></table></div>';
                recordsContainer.innerHTML = content;
                modal.style.display = 'block';

                addRowEventListeners(records);
            }

            // Close modal when the 'x' is clicked
            document.getElementById('closeModal').onclick = function() {
                var modal = document.getElementById('recordsModal');
                modal.style.display = 'none';
            };

            // Close modal when clicking outside of the modal content
            window.onclick = function(event) {
                var modal = document.getElementById('recordsModal');
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            };

        function addRowEventListeners(records) {
            var tableRows = document.querySelectorAll('#recordsContainer tbody tr');
            tableRows.forEach(function(row, index) {
                row.addEventListener('click', function() {
                    tableRows.forEach(function(r) {
                        r.classList.remove('selected');
                    });
                    row.classList.add('selected');
                    var selectedRecord = records[index];
                    displaySelectedRecordDetails(selectedRecord);
                });
            });
        }

        function displaySelectedRecordDetails(record) {
            var fields = record.fields;
            var name = fields['Name'] || 'N/A';
            var uatStage = fields['UAT_Stage'] || 'N/A';
            var prodNumber = fields['Production Framework Number'] || 'N/A';
            var stageNumber = fields['Stage Framework Number'] || 'N/A';

            var label = document.getElementById('selectedRecordLabel');
            label.innerHTML = `
                <strong>Selected Framework</strong>
                <br><strong>Name:</strong> ${name}
                <br><strong>UAT Stage:</strong> ${uatStage}
                <br><strong>Production Number:</strong> ${prodNumber}
                <br><strong>Staging Number:</strong> ${stageNumber}                
            `;
        }
    </script>
</body>
</html>